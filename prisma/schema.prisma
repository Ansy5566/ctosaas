// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// 用户模型
model User {
  id            String   @id @default(cuid())
  email         String   @unique
  name          String
  password      String
  avatar        String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // 关系
  subscription  Subscription?
  tasks         CollectionTask[]
  products      Product[]
  exports       ExportRecord[]

  @@map("users")
}

// 订阅套餐模型
model Subscription {
  id           String   @id @default(cuid())
  userId       String   @unique
  plan         String   // 'free' | 'basic' | 'pro' | 'enterprise'
  quotaTotal   Int
  quotaUsed    Int      @default(0)
  features     String[] // 功能列表
  startDate    DateTime @default(now())
  endDate      DateTime
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // 关系
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

// 采集任务模型
model CollectionTask {
  id                 String   @id @default(cuid())
  userId             String
  platform           String   // Platform type
  type               String   // 'single' | 'category'
  url                String
  status             String   @default("pending") // TaskStatus
  progress           Int      @default(0)
  totalProducts      Int      @default(0)
  collectedProducts  Int      @default(0)
  error              String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  completedAt        DateTime?

  // 关系
  user               User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  products           Product[]

  @@map("collection_tasks")
  @@index([userId])
  @@index([status])
}

// 商品模型
model Product {
  id           String   @id @default(cuid())
  userId       String
  taskId       String
  platform     String   // Platform type
  handle       String
  title        String
  description  String?  @db.Text
  vendor       String?
  productType  String?
  tags         String[]
  images       String[]
  options      Json     // Product options
  status       String   @default("active") // 'draft' | 'active' | 'archived'
  publishedAt  DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // 关系
  user         User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  task         CollectionTask   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  variants     ProductVariant[]

  @@map("products")
  @@index([userId])
  @@index([handle])
  @@index([platform])
}

// 商品变体模型
model ProductVariant {
  id                String   @id @default(cuid())
  productId         String
  sku               String?
  title             String
  price             Float
  compareAtPrice    Float?
  inventoryQuantity Int?
  weight            Float?
  weightUnit        String?
  options           Json     // Variant options
  image             String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // 关系
  product           Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_variants")
  @@index([productId])
}

// 导出记录模型
model ExportRecord {
  id          String    @id @default(cuid())
  userId      String
  format      String    // 'shopify' | 'woocommerce'
  productIds  String[]
  fileUrl     String?
  fileName    String
  status      String    @default("pending") // 'pending' | 'processing' | 'completed' | 'failed'
  error       String?
  createdAt   DateTime  @default(now())
  completedAt DateTime?

  // 关系
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("export_records")
  @@index([userId])
}

// 系统公告模型
model Announcement {
  id        String   @id @default(cuid())
  title     String
  content   String   @db.Text
  type      String   // 'info' | 'warning' | 'success'
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("announcements")
}

// 更新日志模型
model Changelog {
  id          String   @id @default(cuid())
  version     String
  title       String
  description String   @db.Text
  changes     Json     // Array of changes
  publishedAt DateTime @default(now())
  createdAt   DateTime @default(now())

  @@map("changelogs")
}
